<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Схема дома</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="js/ut.js"></script>
  <script src="data/45405619.js"></script>
</head>
<body class="p-4">
  <div id="root"></div>
  <script>
    const displayKeys = ["pl", "ls", "pers", "kv", "dolg", "opl", "nach", "fio"];
    let display = "pl";

    // Создаем новую переменную с данными для работы
    const lsWithZeroFloor = Object.values(ls).map(item => ({ ...item }));

    // Получаем уникальные подъезды
    const entrances = [...new Set(lsWithZeroFloor.map(item => item.pod))].sort();

const calculateZeroFloor = () => {
  const zeroFloorData = {};

  entrances.forEach((pod) => {
    const stacks = [];
    const maxFloor = Math.max(...lsWithZeroFloor.filter(item => item.pod === pod).map(item => item.et)); // Определяем максимальный этаж для текущего подъезда

    // Проходим по всем этажам
    for (let i = 1; i <= maxFloor; i++) {
      const itemsOnFloor = lsWithZeroFloor.filter(item => item.pod === pod && item.et === i);

      // Для каждого этажа суммируем по стоякам
      itemsOnFloor.forEach((item, index) => {
        if (!stacks[index]) stacks[index] = { pers: 0, dolg: 0, opl: 0, nach: 0, pl: 0, ls: 0, kv: 0 }; // Инициализируем стояк

        // Суммируем по каждому ключу
        displayKeys.forEach((key) => {
          if (key === 'fio' || key === 'ls' || key === 'kv') {
            stacks[index][key] = 1+stacks[index][key]; // Для этих полей +1
          } else {
            stacks[index][key] += item[key] || 0; // Для других  суммируем
          }
        });
      });
    }

    // Добавляем данные 0-го этажа
    const zeroFloorStacks = stacks.map((stack, index) => ({
      ...stack,
      et: 0, // Нулевой этаж
      pod, // Подъезд
      kv: stack.kv, // Сумма по квартирам
      ls: stack.ls, // Сумма по ЛС
      fio: "", // Для 0-го этажа пустое поле fio
    }));

    zeroFloorData[pod] = zeroFloorStacks; // Сохраняем итог для подъезда
  });


Object.entries(zeroFloorData).forEach(([pod, stacks]) => {
  stacks.forEach((stack, index) => {
    lsWithZeroFloor.push({
      et: 0,
      pod: parseInt(pod),
      kv: stack.kv,
      ls: stack.ls,
      fio: stack.fio,
      pl: formatNumber(stack.pl),
      pers: stack.pers,
      dolg: stack.dolg,
      opl: stack.opl,
      nach: stack.nach,
    });
  });
});

  return lsWithZeroFloor; // Возвращаем обновленные данные
};

// Вызываем функцию для расчета и обновления данных
const updatedLs = calculateZeroFloor();
console.log(updatedLs);


console.log(lsWithZeroFloor);
    // Получаем уникальные этажи и подъезды с учетом 0-го этажа
    const floors = [...new Set([...lsWithZeroFloor.map((item) => item.et), 0])].sort((a, b) => b - a);

    // Функция для расчета общего значения
    const getTotal = (filterFn, data) => {
      const items = data.filter(filterFn);
      return ["ls", "kv", "fio"].includes(display) ? items.length : items.reduce((sum, item) => sum + (item[display] || 0), 0);
    };

    // Функция для создания кнопки переключения отображения
    const createButton = (key) => {
      const button = document.createElement("button");
      button.classList.add("p-2", "border");
      if (display === key) {
        button.classList.add("bg-blue-500", "text-white");
      }
      button.textContent = key.toUpperCase();
      button.addEventListener("click", () => {
        display = key;
        render();
      });
      return button;
    };

    // Функция для создания строки этажей для каждого подъезда
    const createEntrancesAndFloors = () => {
      const gridContainer = document.createElement("div");
      gridContainer.classList.add("grid", "gap-4");
      gridContainer.style.gridTemplateColumns = `repeat(${entrances.length}, 1fr)`;

      entrances.forEach((pod) => {
        const podDiv = document.createElement("div");
        podDiv.classList.add("border", "p-2");

        const podTitle = document.createElement("div");
        podTitle.classList.add("font-bold");
        podTitle.textContent = `Подъезд ${pod}`;
        podDiv.appendChild(podTitle);

        createFloorsForPod(pod, podDiv); // Вставляем этажи для текущего подъезда

        createPodTotal(pod, podDiv); // Вставляем итог для подъезда

        gridContainer.appendChild(podDiv);
      });

      return gridContainer;
    };

    // Функция для создания этажей в подъезде
    const createFloorsForPod = (pod, podDiv) => {
      floors.forEach((et) => {
        const floorDiv = document.createElement("div");
        floorDiv.classList.add("flex", "gap-2", "items-center");

        const floorNumber = document.createElement("div");
        floorNumber.classList.add("w-8", "text-center", "font-bold");
        floorNumber.textContent = et === 0 ? 0 : et; // Для 0-го этажа отображаем как "0-й этаж"
        floorDiv.appendChild(floorNumber);

        createItemsForFloor(pod, et, floorDiv); // Вставляем элементы для текущего этажа


        podDiv.appendChild(floorDiv);
      });
    };

    // Функция для создания элементов на этаже
    const createItemsForFloor = (pod, et, floorDiv) => {
      const items = lsWithZeroFloor.filter(item => item.et === et && item.pod === pod);
      items.forEach((item) => {
        const itemDiv = document.createElement("div");
        itemDiv.classList.add("border", "p-2", "w-16", "h-16", "flex", "items-center", "justify-center", "text-sm", "break-words");
        itemDiv.textContent = item[display] || "-";
        floorDiv.appendChild(itemDiv);
      });
    };

    // Функция для создания итогового значения по подъезду
    const createPodTotal = (pod, podDiv) => {
      const podTotalDiv = document.createElement("div");
      podTotalDiv.classList.add("text-center", "font-bold", "mt-2");
      podTotalDiv.textContent = `Итого по подъезду: ${formatNumber(getTotal(item => item.pod === pod, lsWithZeroFloor))}`;
      podDiv.appendChild(podTotalDiv);
    };

    // Функция для создания общего итога
    const createTotal = () => {
      const totalDiv = document.createElement("div");
      totalDiv.classList.add("text-center", "font-bold", "mt-4");
      totalDiv.textContent = `Общий итог: ${formatNumber(getTotal(() => true, lsWithZeroFloor))}`;
      return totalDiv;
    };


    // Основная функция для рендеринга всей страницы
    const render = () => {
      const root = document.getElementById("root");
      root.innerHTML = ""; // Очищаем предыдущий контент

      const buttonContainer = document.createElement("div");
      buttonContainer.classList.add("mb-2", "flex", "gap-2");

      // Добавляем кнопки для переключения отображаемых данных
      displayKeys.forEach((key) => {
        buttonContainer.appendChild(createButton(key));
      });

      root.appendChild(buttonContainer);
      root.appendChild(createEntrancesAndFloors()); // Добавляем этажи и подъезды
      root.appendChild(createTotal()); // Добавляем общий итог
    };

    render();
  </script>
</body>
</html>
