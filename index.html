<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Учет в ОСББ/ЖК</title>

  <!-- Styles -->
  <link rel="stylesheet" href="css/schema.css" />
  <link rel="stylesheet" href="css/menu.css" />
  <link rel="stylesheet" href="css/allLs.css" />
  <link rel="stylesheet" href="css/banktable.css" />
  <link rel="stylesheet" href="css/reports.css" />
  <link rel="stylesheet" href="css/print.css" media="print">
  <link rel="stylesheet" href="css/analiz.css">
  <link rel="stylesheet" href="css/dashboard.css">

  <link rel="icon" type="image/png" href="favicon.png" />
<style>
  body:not(.auth-checked) #auth-section,
  body:not(.auth-checked) .sidebar,
  body:not(.auth-checked) .content,
  body:not(.auth-checked) .topbar {
    display: none !important;
  }

  /* ===== INITIAL SESSION PRELOADER ===== */

  .preloader {
    position: fixed;
    inset: 0;
    background: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }

  .preloader.hidden {
    display: none;
  }

  .session-check {
    display: inline-flex;
    gap: 6px;
  }

  .session-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #666;
    opacity: 0;
    animation: sessionPulse 1.4s infinite;
  }

  .session-dot:nth-child(2) { animation-delay: .2s; }
  .session-dot:nth-child(3) { animation-delay: .4s; }

  @keyframes sessionPulse {
    0%   { opacity: 0; }
    30%  { opacity: 1; }
    60%  { opacity: 0; }
    100% { opacity: 0; }
  }

</style>

</head>

<body>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<!-- ================= AUTH ================= -->

<div id="auth-section">
  <form id="login-form">
    <h2>Вход</h2>
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Пароль" required />
    <button type="submit">Увійти</button>
    <div id="login-status"></div>
    <div id="auth-toggle">
      <span id="show-signup" style="color:#007bff; cursor:pointer;">
        Нет аккаунта? Зарегистрироваться
      </span>
    </div>
  </form>

  <form id="signup-form" style="display:none;">
    <h2>Регистрация</h2>
    <input type="email" id="signup-email" placeholder="Email" required />
    <input type="password" id="signup-password" placeholder="Пароль" required minlength="6" />
    <input type="password" id="signup-password-confirm" placeholder="Подтвердите пароль" required minlength="6" />
    <button type="submit">Зарегистрироваться</button>
    <div id="signup-status"></div>
    <div id="auth-toggle">
      <span id="show-login" style="color:#007bff; cursor:pointer;">
        Уже есть аккаунт? Войти
      </span>
    </div>
  </form>
</div>

<!-- ================= TOPBAR ================= -->

<div class="topbar" id="topbar">
  <button id="hamburger" class="hamburger" type="button" onclick="toggleMenu()">☰</button>
  <button id="backFromFiles" class="topbar-back" onclick="exitFilesMode()">
    ← Повернутися до головного меню
  </button>
  <div class="topbar-title" id="topbar-title"></div>
</div>

<!-- ================= SIDEBAR ================= -->

<nav class="sidebar" id="sidebar">
  <div class="sidebar-menu">
    <input type="text" id="searchHomes" placeholder="Поиск дома..." />
    <ul class="menu" id="menu"></ul>
  </div>
  <div class="sidebar-files" id="filebar"></div>
</nav>

<!-- ================= CONTENT ================= -->

<div id="preloader" class="preloader">
  <div class="session-check">
    <span class="session-dot"></span>
    <span class="session-dot"></span>
    <span class="session-dot"></span>
  </div>
</div>

<div class="content">
  <div id="maincontainer"></div>
</div>

<!-- ================= APP SCRIPTS ================= -->

<script src="js/ut.js"></script>
<script src="js/addstuf.js"></script>
<script src="js/analiz.js"></script>
<script src="js/table.js"></script>
<script src="js/paytable.js"></script>
<script src="js/banktable.js"></script>
<script src="js/menu.js"></script>
<script src="js/homeinfo.js"></script>
<script src="js/schema.js"></script>
<script src="js/reports.js"></script>
<script src="js/dashboard.js"></script>

<script>
  const client = window.supabase.createClient(
    "https://bollarpnewbhziwldzjn.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvbGxhcnBuZXdiaHppd2xkempuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNjY4MjYsImV4cCI6MjA2Njk0MjgyNn0.KhmT9U5wKm0irQbidZjZXCSOfzfr1gYYmo_21VL1JPw"
  );

  async function enterAppMode() {
    document.getElementById("auth-section").style.display = "none";

    document.body.classList.add("authenticated", "app");
    document.body.classList.remove("files-mode");
    document.body.classList.remove("sidebar-open");

    document.querySelector(".sidebar").style.display = "block";
    document.querySelector(".content").style.display = "block";
    document.getElementById("hamburger").style.display = "flex";

    await loadHomesAndBuildMenu();
  }

  async function enterAuthMode() {
    document.getElementById("auth-section").style.display = "block";

    document.body.classList.remove(
      "authenticated",
      "app",
      "files-mode",
      "sidebar-open"
    );

    document.querySelector(".sidebar").style.display = "none";
    document.querySelector(".content").style.display = "none";
    document.getElementById("hamburger").style.display = "none";
  }

  // ===== INITIAL SESSION CHECK =====
  (async () => {
    const preloader = document.getElementById("preloader");

    try {
      let { data: { session } } = await client.auth.getSession();

      if (!session) {
        const res = await client.auth.refreshSession();
        session = res.data.session;
      }

      if (session) {
        await enterAppMode();
      } else {
        enterAuthMode();
      }
    } finally {
      // снимаем блокировку интерфейса
      document.body.classList.add("auth-checked");

      // убираем прелоадер
      if (preloader) preloader.classList.add("hidden");
    }
  })();


  // ===== FORM TOGGLES =====
  document.getElementById("show-signup").onclick = () => {
    document.getElementById("login-form").style.display = "none";
    document.getElementById("signup-form").style.display = "block";
  };

  document.getElementById("show-login").onclick = () => {
    document.getElementById("signup-form").style.display = "none";
    document.getElementById("login-form").style.display = "block";
  };

  // ===== LOGIN =====
  document.getElementById("login-form").addEventListener("submit", async e => {
    e.preventDefault();

    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const statusEl = document.getElementById("login-status");

    const { error } = await client.auth.signInWithPassword({ email, password });

    if (error) {
      statusEl.textContent = "❌ Помилка входу: " + error.message;
      return;
    }

    statusEl.textContent = "✅ Успішний вхід";
    await enterAppMode();
  });

  // ===== SIGNUP =====
  document.getElementById("signup-form").addEventListener("submit", async e => {
    e.preventDefault();

    const email = document.getElementById("signup-email").value;
    const password = document.getElementById("signup-password").value;
    const confirm = document.getElementById("signup-password-confirm").value;
    const statusEl = document.getElementById("signup-status");

    if (password !== confirm) {
      statusEl.textContent = "❌ Пароли не совпадают";
      return;
    }

    const { error } = await client.auth.signUp({ email, password });

    if (error) {
      statusEl.textContent = "❌ Ошибка регистрации: " + error.message;
    } else {
      statusEl.style.color = "green";
      statusEl.textContent = "✅ Регистрация успешна! Проверьте почту.";
    }
  });
</script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script> !-->
</body>
</html>
